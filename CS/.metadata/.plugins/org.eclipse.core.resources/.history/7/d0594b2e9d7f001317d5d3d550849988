package com.xjiang.fivechess.robot;

import java.util.Map;

import com.crgp.game.client.message.ActionMessage;
import com.crgp.game.client.message.DataMessage;
import com.crgp.game.client.message.Message;
import com.crgp.robot.BaseRobot;

public abstract class MineRobot extends BaseRobot {
	public static final String GAME_UID = "CRGP-Mine-Game";

	@Override
	public String GameUID() {
		return GAME_UID;
	}

	@Override
	public final synchronized Map<String, String> play(int code) {
		return play();
	}

	/**
	 * æ¯æ¬¡éœ?¦æœºå™¨äººç‚¹å‡»ä¸€ä¸ªé›·ç‚¹çš„æ—¶å?ä¼šè°ƒç”¨è¯¥æ–¹æ³•;<BR>
	 * è¯¥æ–¹æ³•åªå…è®¸è°ƒç”¨ä¸?¬¡clickï¼?BR>
	 * è°ƒç”¨clickåæ‰§è¡Œå™¨ä¼šæ”¶å›æœºå™¨äººçš„ä»£ç æ‰§è¡Œæƒé™ï¼Œå³clickæ–¹æ³•åé¢çš„ä»£ç ä¸ä¼šè¢«æ‰§è¡Œ, ç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒç”¨play<BR>
	 */
	public abstract Map<String, String> play();

	// -------------------------
	// ---
	// ---ä¿¡å·ä¸æ§½(Signal and Slots)
	// ---
	// -------------------------
	/**
	 * [SIGNAL]è·å¾—å®½åº¦å€?
	 * 
	 * @return
	 */
	public final int getWidth() {
		// æ„å»ºæ±‚æƒ…æ¶ˆæ¯
		ActionMessage actionMessage = new ActionMessage(Message.TYPE_ROBOT,
				RobotUID(), Message.TYPE_GAME, GAME_UID);
		actionMessage.setActionName("getWidth");
		actionMessage.setHasReceipt(true);

		// å‘é?æ¶ˆæ¯å¹¶è·å–ç»“æœæ•°æ?
		DataMessage dataMessage = client.send(actionMessage);

		// è§£æç»“æœæ•°æ®
		return Integer.parseInt(dataMessage.getData("width"));
	}

	/**
	 * [SIGNAL]è·å¾—é«˜åº¦å€?
	 * 
	 * @return
	 */
	public final int getHeight() {
		// æ„å»ºæ±‚æƒ…æ¶ˆæ¯
		ActionMessage actionMessage = new ActionMessage(Message.TYPE_ROBOT,
				RobotUID(), Message.TYPE_GAME, GAME_UID);
		actionMessage.setActionName("getHeight");
		actionMessage.setHasReceipt(true);

		// å‘é?æ¶ˆæ¯å¹¶è·å–ç»“æœæ•°æ?
		DataMessage dataMessage = client.send(actionMessage);

		// è§£æç»“æœæ•°æ®
		return Integer.parseInt(dataMessage.getData("height"));
	}

	/**
	 * [SIGNAL]è·å¾—åœ°é›·æ€»æ•°
	 * 
	 * @return
	 */
	public final int getMineCount() {
		// æ„å»ºæ±‚æƒ…æ¶ˆæ¯
		ActionMessage actionMessage = new ActionMessage(Message.TYPE_ROBOT,
				RobotUID(), Message.TYPE_GAME, GAME_UID);
		actionMessage.setActionName("getMineCount");
		actionMessage.setHasReceipt(true);

		// å‘é?æ¶ˆæ¯å¹¶è·å–ç»“æœæ•°æ?
		DataMessage dataMessage = client.send(actionMessage);

		// è§£æç»“æœæ•°æ®
		return Integer.parseInt(dataMessage.getData("mineCount"));
	}

	/**
	 * [SIGNAL]ç‚¹å‡»ä¸?¸ªé›·ç‚¹
	 * 
	 * @param x
	 *            æ¨ªå‘ä½ç½®
	 * @param y
	 *            çºµå‘ä½ç½®
	 */
	public final void click(int x, int y) {
		// æ„å»ºæ±‚æƒ…æ¶ˆæ¯
		ActionMessage actionMessage = new ActionMessage(Message.TYPE_ROBOT,
				RobotUID(), Message.TYPE_GAME, GAME_UID);
		actionMessage.setActionName("click");
		actionMessage.setHasReceipt(false);
		actionMessage.addParam("x", x + "");
		actionMessage.addParam("y", y + "");

		// å‘é?æ¶ˆæ¯
		client.send(actionMessage);
	}

	/**
	 * [SIGNAL]è·å–æ‰?œ‰ä½ç½®çš„ä¿¡æ¯ï¼Œä»¥äºŒç»´æ•°ç»„çš„å½¢å¼è¿”å›
	 * 
	 * @return -1:æœªçŸ¥,0-N:è¯¥ä½ç½®çš„å€?
	 */
	public final int[][] getMap() {
		// æ„å»ºæ±‚æƒ…æ¶ˆæ¯
		ActionMessage actionMessage = new ActionMessage(Message.TYPE_ROBOT,
				RobotUID(), Message.TYPE_GAME, GAME_UID);
		actionMessage.setActionName("getMap");
		actionMessage.setHasReceipt(true);

		// å‘é?æ¶ˆæ¯å¹¶è·å–ç»“æœæ•°æ?
		DataMessage dataMessage = client.send(actionMessage);

		// è§£æç»“æœæ•°æ®
		String tmp1 = dataMessage.getData("map");
		tmp1 = tmp1.substring(1, tmp1.length() - 1);

		String as1[] = tmp1.split("\\|");
		int[][] arrays = new int[as1.length][];
		for (int i = 0; i < as1.length; i++) {
			String tmp2 = as1[i];
			tmp2 = tmp2.substring(1, tmp2.length() - 1);

			String as2[] = tmp2.split(",");
			arrays[i] = new int[as2.length];
			for (int j = 0; j < as2.length; j++) {
				arrays[i][j] = Integer.parseInt(as2[j].trim());
			}
		}
		return arrays;
	}
}
